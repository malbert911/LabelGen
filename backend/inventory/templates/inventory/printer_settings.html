{% extends "inventory/base.html" %}

{% block title %}Printer Settings - LabelGen{% endblock %}

{% block content %}
<div class="container">
    <h1 class="title">
        <span class="icon-text">
            <span class="icon"><i class="fas fa-print"></i></span>
            <span>Printer Settings</span>
        </span>
    </h1>
    <p class="subtitle">Configure which printers to use for labels</p>

    <div class="notification is-info is-light">
        <p><strong>Note:</strong> Printer settings are saved locally in your browser and apply only to this workstation.</p>
    </div>

    <!-- Connection Status -->
    <div class="box">
        <h2 class="title is-4">
            <span class="icon-text">
                <span class="icon"><i class="fas fa-plug"></i></span>
                <span>Bridge Connection</span>
            </span>
        </h2>
        <div id="bridgeStatus" class="notification is-warning">
            <span class="icon"><i class="fas fa-spinner fa-pulse"></i></span>
            <span>Connecting to printer bridge...</span>
        </div>
        <button class="button is-info" id="refreshPrinters">
            <span class="icon"><i class="fas fa-sync"></i></span>
            <span>Refresh Printers</span>
        </button>
    </div>

    <!-- Serial Label Printer -->
    <div class="box">
        <h2 class="title is-4">
            <span class="icon-text">
                <span class="icon"><i class="fas fa-barcode"></i></span>
                <span>Serial Number Label Printer</span>
            </span>
        </h2>
        <p class="mb-3">Used for printing individual serial number labels during bulk generation</p>
        
        <div class="field">
            <label class="label">Select Printer</label>
            <div class="control">
                <div class="select is-fullwidth" id="serialPrinterSelect">
                    <select id="serialPrinter">
                        <option value="">-- No printer selected --</option>
                    </select>
                </div>
            </div>
            <p class="help" id="serialPrinterInfo"></p>
        </div>
    </div>

    <!-- Box Label Printer -->
    <div class="box">
        <h2 class="title is-4">
            <span class="icon-text">
                <span class="icon"><i class="fas fa-box"></i></span>
                <span>Box Label Printer</span>
            </span>
        </h2>
        <p class="mb-3">Used for printing shipping box labels</p>
        
        <div class="field">
            <label class="label">Select Printer</label>
            <div class="control">
                <div class="select is-fullwidth" id="boxPrinterSelect">
                    <select id="boxPrinter">
                        <option value="">-- No printer selected --</option>
                    </select>
                </div>
            </div>
            <p class="help" id="boxPrinterInfo"></p>
        </div>
    </div>

    <!-- Save Button -->
    <div class="box has-background-light">
        <button class="button is-primary is-large" id="savePrinters">
            <span class="icon"><i class="fas fa-save"></i></span>
            <span>Save Printer Settings</span>
        </button>
    </div>
</div>

<script>
const BRIDGE_URL = 'http://localhost:5001';
let availablePrinters = [];

// Load saved printer settings
function loadSavedSettings() {
    const serialPrinter = localStorage.getItem('labelgen_serial_printer');
    const boxPrinter = localStorage.getItem('labelgen_box_printer');
    
    if (serialPrinter) {
        document.getElementById('serialPrinter').value = serialPrinter;
        updatePrinterInfo('serial', serialPrinter);
    }
    if (boxPrinter) {
        document.getElementById('boxPrinter').value = boxPrinter;
        updatePrinterInfo('box', boxPrinter);
    }
}

// Fetch available printers from bridge
async function fetchPrinters() {
    const statusEl = document.getElementById('bridgeStatus');
    const refreshBtn = document.getElementById('refreshPrinters');
    
    refreshBtn.classList.add('is-loading');
    statusEl.className = 'notification is-info';
    statusEl.innerHTML = '<span class="icon"><i class="fas fa-spinner fa-pulse"></i></span><span>Fetching printers...</span>';
    
    try {
        const response = await fetch(`${BRIDGE_URL}/printers`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.printers) {
            availablePrinters = data.printers;
            populatePrinterDropdowns();
            
            statusEl.className = 'notification is-success';
            statusEl.innerHTML = `<span class="icon"><i class="fas fa-check-circle"></i></span><span>Connected • Found ${data.printers.length} printer(s)</span>`;
        } else {
            throw new Error('Invalid response from bridge');
        }
    } catch (error) {
        console.error('Failed to fetch printers:', error);
        statusEl.className = 'notification is-danger';
        statusEl.innerHTML = `<span class="icon"><i class="fas fa-exclamation-triangle"></i></span><span>Failed to connect to printer bridge at ${BRIDGE_URL}</span>`;
        
        // Clear dropdowns
        document.getElementById('serialPrinter').innerHTML = '<option value="">-- Bridge not available --</option>';
        document.getElementById('boxPrinter').innerHTML = '<option value="">-- Bridge not available --</option>';
    } finally {
        refreshBtn.classList.remove('is-loading');
    }
}

// Populate printer dropdowns
function populatePrinterDropdowns() {
    const serialSelect = document.getElementById('serialPrinter');
    const boxSelect = document.getElementById('boxPrinter');
    
    const savedSerial = serialSelect.value;
    const savedBox = boxSelect.value;
    
    // Build options HTML
    let optionsHTML = '<option value="">-- No printer selected --</option>';
    availablePrinters.forEach(printer => {
        optionsHTML += `<option value="${printer.id}">${printer.name} (${printer.connection})</option>`;
    });
    
    serialSelect.innerHTML = optionsHTML;
    boxSelect.innerHTML = optionsHTML;
    
    // Restore selections
    if (savedSerial) serialSelect.value = savedSerial;
    if (savedBox) boxSelect.value = savedBox;
    
    loadSavedSettings();
}

// Update printer info text
function updatePrinterInfo(type, printerId) {
    const printer = availablePrinters.find(p => p.id === printerId);
    const infoEl = document.getElementById(`${type}PrinterInfo`);
    
    if (printer) {
        infoEl.className = 'help is-success';
        infoEl.textContent = `${printer.description} • ${printer.type} • ${printer.status}`;
    } else {
        infoEl.className = 'help';
        infoEl.textContent = '';
    }
}

// Save printer settings
document.getElementById('savePrinters').addEventListener('click', function() {
    const serialPrinter = document.getElementById('serialPrinter').value;
    const boxPrinter = document.getElementById('boxPrinter').value;
    
    if (serialPrinter) {
        localStorage.setItem('labelgen_serial_printer', serialPrinter);
    } else {
        localStorage.removeItem('labelgen_serial_printer');
    }
    
    if (boxPrinter) {
        localStorage.setItem('labelgen_box_printer', boxPrinter);
    } else {
        localStorage.removeItem('labelgen_box_printer');
    }
    
    // Show success message
    const btn = this;
    const originalHTML = btn.innerHTML;
    btn.className = 'button is-success is-large';
    btn.innerHTML = '<span class="icon"><i class="fas fa-check"></i></span><span>Settings Saved!</span>';
    
    setTimeout(() => {
        btn.className = 'button is-primary is-large';
        btn.innerHTML = originalHTML;
    }, 2000);
});

// Refresh button handler
document.getElementById('refreshPrinters').addEventListener('click', fetchPrinters);

// Dropdown change handlers
document.getElementById('serialPrinter').addEventListener('change', function() {
    updatePrinterInfo('serial', this.value);
});

document.getElementById('boxPrinter').addEventListener('change', function() {
    updatePrinterInfo('box', this.value);
});

// Initial load
fetchPrinters();
</script>
{% endblock %}
