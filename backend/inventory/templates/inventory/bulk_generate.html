{% extends "inventory/base.html" %}

{% block title %}Bulk Serial Generation - LabelGen{% endblock %}

{% block content %}
<div class="columns">
    <div class="column">
        <h1 class="title">
            <span class="icon-text">
                <span class="icon"><i class="fas fa-barcode"></i></span>
                <span>Bulk Serial Number Generation</span>
            </span>
        </h1>
        <p class="subtitle">Scan part numbers and quantities to generate serial numbers</p>
    </div>
    <div class="column is-narrow">
        <div class="box has-background-info">
            <p class="has-text-weight-bold">Next Serial:</p>
            <p class="is-size-4 is-family-monospace" id="nextSerialDisplay">{{ sample_serial }}</p>
        </div>
    </div>
</div>

<!-- Scanning Input Table -->
<div class="box">
    <h2 class="title is-4">Scan Items</h2>
    <p class="mb-4">
        <span class="tag is-info is-light">
            <span class="icon"><i class="fas fa-info-circle"></i></span>
            <span>Scan alternating: Part Number → Quantity → Part Number → Quantity</span>
        </span>
    </p>
    
    <table class="table is-fullwidth is-striped" id="scanTable">
        <thead>
            <tr>
                <th width="10%">#</th>
                <th width="40%">Part Number</th>
                <th width="20%">Quantity</th>
                <th width="30%">Serial Range (Preview)</th>
            </tr>
        </thead>
        <tbody id="scanTableBody">
            <!-- Rows will be added dynamically -->
            <tr data-row="0">
                <td>1</td>
                <td>
                    <input type="text" 
                           class="input scan-input part-input" 
                           data-row="0"
                           placeholder="Scan Part Number"
                           autocomplete="off">
                </td>
                <td>
                    <input type="text" 
                           class="input scan-input qty-input" 
                           data-row="0"
                           placeholder="Scan Quantity"
                           autocomplete="off">
                </td>
                <td class="serial-range" data-row="0">-</td>
            </tr>
        </tbody>
    </table>
    
    <div class="buttons is-right mt-4">
        <button class="button is-light" id="clearBtn">
            <span class="icon"><i class="fas fa-eraser"></i></span>
            <span>Clear All</span>
        </button>
        <button class="button is-primary is-large" id="generateBtn" disabled>
            <span class="icon"><i class="fas fa-cogs"></i></span>
            <span>Generate & Print Labels (Space)</span>
        </button>
    </div>
</div>

<!-- Results Section -->
<div id="resultsSection" style="display: none;">
    <div class="box">
        <h2 class="title is-4">Generation Results</h2>
        <div id="resultsContent"></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================================
// STATE & CONFIGURATION
// ============================================================================
let currentRow = 0;
let currentSerial = {{ config.current_serial }};
const digitCount = {{ config.serial_digits }};
let generatedSerials = [];

const BUTTON_DEFAULT_HTML = '<span class="icon"><i class="fas fa-cogs"></i></span><span>Generate & Print Labels (Space)</span>';

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function formatSerial(num) {
    return String(num).padStart(digitCount, '0');
}

function addNewRow() {
    currentRow++;
    const tbody = document.getElementById('scanTableBody');
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-row', currentRow);
    newRow.innerHTML = `
        <td>${currentRow + 1}</td>
        <td>
            <input type="text" 
                   class="input scan-input part-input" 
                   data-row="${currentRow}"
                   placeholder="Scan Part Number"
                   autocomplete="off">
        </td>
        <td>
            <input type="text" 
                   class="input scan-input qty-input" 
                   data-row="${currentRow}"
                   placeholder="Scan Quantity"
                   autocomplete="off">
        </td>
        <td class="serial-range" data-row="${currentRow}">-</td>
    `;
    tbody.appendChild(newRow);
    attachRowHandlers(newRow);
}

function updateSerialRange(row) {
    const partInput = document.querySelector(`.part-input[data-row="${row}"]`);
    const qtyInput = document.querySelector(`.qty-input[data-row="${row}"]`);
    const rangeCell = document.querySelector(`.serial-range[data-row="${row}"]`);
    
    const qty = parseInt(qtyInput.value);
    if (qty > 0) {
        // Calculate cumulative offset from previous rows
        let offset = 0;
        for (let i = 0; i < row; i++) {
            const prevQty = parseInt(document.querySelector(`.qty-input[data-row="${i}"]`).value);
            if (prevQty > 0) offset += prevQty;
        }
        
        const start = currentSerial + offset;
        const end = start + qty - 1;
        rangeCell.textContent = `${formatSerial(start)} - ${formatSerial(end)}`;
        rangeCell.classList.add('has-text-success', 'has-text-weight-bold');
    } else {
        rangeCell.textContent = '-';
        rangeCell.classList.remove('has-text-success', 'has-text-weight-bold');
    }
}

function checkGenerateButton() {
    const allInputs = document.querySelectorAll('.part-input, .qty-input');
    const hasData = Array.from(allInputs).some(input => input.value.trim());
    document.getElementById('generateBtn').disabled = !hasData;
}

// ============================================================================
// ROW MANAGEMENT
// ============================================================================

function attachRowHandlers(row) {
    const rowNum = parseInt(row.getAttribute('data-row'));
    const partInput = row.querySelector('.part-input');
    const qtyInput = row.querySelector('.qty-input');
    
    partInput.addEventListener('input', function(e) {
        if (e.target.value.includes('\n') || e.target.value.includes('\t')) {
            e.target.value = e.target.value.replace(/[\n\t]/g, '');
            qtyInput.focus();
        }
        checkGenerateButton();
    });
    
    partInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === 'Tab') {
            e.preventDefault();
            qtyInput.focus();
        }
    });
    
    qtyInput.addEventListener('input', function(e) {
        if (e.target.value.includes('\n') || e.target.value.includes('\t')) {
            e.target.value = e.target.value.replace(/[\n\t]/g, '');
        }
        updateSerialRange(rowNum);
        checkGenerateButton();
        
    });
    
    qtyInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === 'Tab') {
            e.preventDefault();
            updateSerialRange(rowNum);
            addNewRow();

            const nextRow = rowNum + 1;
            // Wait for DOM update before focusing
            requestAnimationFrame(() => {
                const nextPartInput = document.querySelector(`.part-input[data-row="${nextRow}"]`);
                if (nextPartInput) {
                    nextPartInput.focus();
                }
            });
        }
    });
}

// ============================================================================
// INITIALIZATION
// ============================================================================

// Initialize handlers for existing rows
document.querySelectorAll('tr[data-row]').forEach(attachRowHandlers);

// Auto-focus first input on page load
window.addEventListener('DOMContentLoaded', () => {
    document.querySelector('.part-input[data-row="0"]').focus();
});

// ============================================================================
// BUTTON HANDLERS
// ============================================================================

// Clear button
document.getElementById('clearBtn').addEventListener('click', () => {
    if (confirm('Clear all scanned data?')) {
        location.reload();
    }
});

// Generate & Print button - handles entire workflow
document.getElementById('generateBtn').addEventListener('click', async function() {
    const btn = this;
    btn.classList.add('is-loading');
    btn.disabled = true;
    
    // Check if printer is selected upfront
    const selectedPrinter = PrinterBridge.getSelectedPrinter('serial');
    if (!selectedPrinter) {
        showNotification('Please select a serial label printer in Printer Settings first', 'warning');
        btn.classList.remove('is-loading');
        btn.disabled = false;
        setTimeout(() => {
            window.location.href = '/printer-settings/';
        }, 2000);
        return;
    }
    
    // Collect all pairs
    const pairs = [];
    document.querySelectorAll('tr[data-row]').forEach(row => {
        const rowNum = row.getAttribute('data-row');
        const partInput = document.querySelector(`.part-input[data-row="${rowNum}"]`);
        const qtyInput = document.querySelector(`.qty-input[data-row="${rowNum}"]`);
        
        if (partInput.value.trim() && qtyInput.value.trim()) {
            pairs.push({
                part_number: partInput.value.trim(),
                quantity: qtyInput.value.trim()
            });
        }
    });
    
    try {
        // Step 1: Generate serials
        btn.innerHTML = '<span class="icon"><i class="fas fa-cogs fa-spin"></i></span><span>Generating...</span>';
        
        const response = await fetch('/api/process-bulk-scans/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ pairs })
        });
        
        const result = await response.json();
        
        if (!result.success) {
            showNotification(`❌ Error: ${result.error}`, 'danger');
            btn.classList.remove('is-loading');
            btn.disabled = false;
            btn.innerHTML = BUTTON_DEFAULT_HTML;
            return;
        }
        
        // Store generated serials
        generatedSerials = [];
        result.data.results.forEach(res => {
            if (res.success && res.serials) {
                res.serials.forEach(serial => {
                    generatedSerials.push({
                        serial_number: serial.serial_number,
                        part_number: res.part_number,
                        upc: serial.upc || ''
                    });
                });
            }
        });
        
        showNotification(`✅ Generated ${result.data.total_serials} serial numbers!`, 'success');
        
        // Update current serial for next batch
        currentSerial += result.data.total_serials;
        
        // Step 2: Print automatically
        btn.innerHTML = '<span class="icon"><i class="fas fa-print fa-spin"></i></span><span>Printing...</span>';
        
        await printAllLabelsInline(btn, selectedPrinter);
        
    } catch (error) {
        showNotification(`❌ Error: ${error.message}`, 'danger');
        btn.classList.remove('is-loading');
        btn.disabled = false;
        btn.innerHTML = BUTTON_DEFAULT_HTML;
    }
});

// ============================================================================
// PRINT WORKFLOW
// ============================================================================
/**
 * Print all labels inline after generation and reset form
 */
async function printAllLabelsInline(btn, selectedPrinter) {
    if (generatedSerials.length === 0) {
        showNotification('No labels to print', 'warning');
        resetForm(btn);
        return;
    }
    
    try {
        const result = await PrinterBridge.printBatch(
            'serial',
            generatedSerials,
            selectedPrinter,
            (current, total) => {
                btn.innerHTML = `<span class="icon"><i class="fas fa-print fa-spin"></i></span><span>Printing ${current}/${total}...</span>`;
            }
        );
        
        if (result.failed > 0) {
            showNotification(`Batch complete: ${result.successful} printed, ${result.failed} failed`, 'warning');
        } else {
            showNotification(`✅ All ${result.successful} labels printed successfully!`, 'success');
        }
        
        resetForm(btn);
        
    } catch (error) {
        showNotification(`Print error: ${error.message}`, 'danger');
        resetForm(btn);
    }
}

/**
 * Reset the entire form for next batch
 */
function resetForm(btn) {
    // Clear all inputs
    document.querySelectorAll('.part-input, .qty-input').forEach(input => {
        input.value = '';
    });
    
    // Clear serial ranges
    document.querySelectorAll('.serial-range').forEach(cell => {
        cell.textContent = '-';
        cell.classList.remove('has-text-success', 'has-text-weight-bold');
    });
    
    // Remove extra rows, keep only the first one
    const tbody = document.getElementById('scanTableBody');
    const rows = tbody.querySelectorAll('tr[data-row]');
    rows.forEach((row, index) => {
        if (index > 0) {
            row.remove();
        }
    });
    
    // Reset row counter
    currentRow = 0;
    
    // Reset button state
    btn.classList.remove('is-loading');
    btn.disabled = false;
    btn.innerHTML = BUTTON_DEFAULT_HTML;
    
    // Update Next Serial display
    document.getElementById('nextSerialDisplay').textContent = formatSerial(currentSerial);
    
    // Hide results section (if visible)
    document.getElementById('resultsSection').style.display = 'none';
    
    // Focus first input for next batch
    document.querySelector('.part-input[data-row="0"]').focus();
}

// ============================================================================
// KEYBOARD SHORTCUTS
// ============================================================================
/**
 * Spacebar shortcut
 */
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
        const generateBtn = document.getElementById('generateBtn');
        if (generateBtn && !generateBtn.disabled) {
            e.preventDefault();
            generateBtn.click();
        }
    }
});
</script>
{% endblock %}
